<!DOCTYPE html>
<meta name=viewport content=width=device-width>
<style>

html {
  font: 48px system-ui;
  font-variant-numeric: tabular-nums;
  text-align: center;
  background: #222;
  color: white;
  height: 100%;
  display: flex;
  align-items: center;
  justify-content: center;
}

html.syncing {
  cursor: none;
}

html.syncing #sync {
  display: none;
}

html.tick {
  background: white;
  color: black;
}

body {
}

@keyframes tick {
  from {
    background: white;
    color: black;
  }
  to {
  }
}

</style>
<h1 id=clockTime></h1>
<button id=sync>Sync to me</button>
<script type=module>
"use strict";

let clockOffset = 0;
let bestRtt;

const formatTime = ms => {
  return Math.floor(ms / (1000/60));
  let h = Math.floor(ms / 3600000);
  let m = Math.floor(ms / 60000) % 60;
  let s = Math.floor(ms / 1000) % 60;
  let frac = Math.floor(ms / 10) % 100;
  return [h, m, s].map(x => x.toFixed().padStart(2, '0')).join(':') + '.' + frac.toFixed().padStart(2, '0');
};

const tick = now => {
  now -= clockOffset;
  if (bestRtt != null)
   now += bestRtt / 2;
  const frame = Math.floor(now / (1000/60));
  clockTime.textContent = frame;
  document.documentElement.classList[Math.floor(frame / 50) % 2 ? 'add' : 'remove']('tick');
  requestAnimationFrame(tick);
};

tick(performance.now());

let isSource = false;

sync.addEventListener('click', e => {
  isSource = true;
  document.documentElement.classList.add('syncing');
  window.dispatchEvent(new CustomEvent('sendbroadcast', { detail: {
    type: "clockset",
    value: performance.now(),
  }}))
  setInterval(() => {
    window.dispatchEvent(new CustomEvent('sendbroadcast', { detail: {
      type: "clocktune",
      value: performance.now(),
    }}))
  }, 1000);
});

let pingStartTime;
let pingId;

window.addEventListener('broadcast', e => {
  const {type, value} = e.detail;
  if (type == 'clockset' && !isSource) {
    clockOffset = performance.now() - value;
    bestRtt = null;
    document.documentElement.classList.add('syncing');
  } else if (type == 'clocktune' && !isSource) {
    const oldClockOffset = clockOffset;
    clockOffset = Math.min(clockOffset, performance.now() - value);
    if (clockOffset - oldClockOffset)
      console.log('tweak', clockOffset - oldClockOffset);
    if (!pingId) {
      pingStartTime = performance.now();
      window.dispatchEvent(new CustomEvent('sendbroadcast', { detail: {
        type: "ping",
        value: (pingId = Math.random() * 1000),
      }}));
    }
  } else if (type == 'ping' && isSource) {
    window.dispatchEvent(new CustomEvent('sendbroadcast', { detail: {
      type: "pong",
      value: value,
    }}));
  } else if (type == 'pong' && value == pingId) {
    const oldBestRtt = bestRtt;
    if (bestRtt)
      bestRtt = Math.min(bestRtt, performance.now() - pingStartTime);
    else
      bestRtt = performance.now() - pingStartTime;
    if (oldBestRtt != bestRtt)
      console.log('rtt', bestRtt);
    pingId = null;
  }
});

</script>
